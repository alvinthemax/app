<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub Content Manager</title>
  <style>
    :root {
      --bg: #f2f2f2;
      --panel: #fff;
      --item: #f5f5f5;
      --text: #111;
      --muted: #666;
      --accent: #111;
      --line: #ccc;
      --input-bg: #fff;
      --button-bg: #111;
      --sidebar-bg: #fff;
      --sidebar-width: 300px;
      --header-height: 56px;
      --danger: #e53935;
      --warning: #ff9800;
      --success: #4caf50;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      padding-bottom: 80px;
    }

    /* HEADER */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      background: var(--panel);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
      z-index: 400;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header button {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .search-container {
      display: flex;
      align-items: center;
      background: #f5f5f5;
      border-radius: 20px;
      padding: 4px 12px;
      flex: 1;
      max-width: 400px;
    }

    .search-container input {
      border: none;
      background: transparent;
      padding: 6px 8px;
      font-size: 14px;
      flex: 1;
      outline: none;
      width: 100%;
    }

    .search-container button {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
    }

    /* TAB */
    .tab-container {
      position: relative;
      top: 72px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 320px;
      z-index: 100;
      transition: opacity .2s ease;
      margin-bottom: 20px;
    }

    .sidebar.active ~ .tab-container {
      opacity: .4;
      pointer-events: none;
    }

    .tab-wrapper {
      display: flex;
      background: #dedede;
      border-radius: 14px;
      padding: 4px;
    }

    .tab {
      flex: 1;
      padding: 12px 0;
      text-align: center;
      font-weight: 600;
      color: #666;
      border-radius: 10px;
      cursor: pointer;
    }

    .tab.active {
      background: var(--panel);
      color: var(--text);
      box-shadow: 0 2px 6px rgba(0,0,0,.12);
    }

    /* Tambah Konten Button */
    #addContentBtn {
      margin: 12px auto;
      display: block;
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      background: var(--button-bg);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }

    /* CARD */
    .card {
      background: var(--panel);
      margin: 8px auto;
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      max-width: 320px;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .card-title {
      font-weight: 600;
      font-size: 16px;
      flex: 1;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .card-actions {
      display: flex;
      gap: 4px;
    }

    .card-actions button {
      border: none;
      background: none;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .property-group {
      margin: 8px 0;
    }

    .property-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .property-label .toggle-btn {
      background: none;
      border: none;
      font-size: 12px;
      cursor: pointer;
      padding: 0 4px;
    }

    .property-values {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      padding-bottom: 4px;
      flex-wrap: nowrap;
    }

    .property-values.vertical {
      flex-direction: column;
      overflow-x: visible;
      flex-wrap: wrap;
    }

    .property-value {
      background: var(--item);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      white-space: nowrap;
      flex-shrink: 0;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .property-values.vertical .property-value {
      white-space: normal;
      word-break: break-word;
    }

    /* IMAGE PREVIEW */
    .image-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .image-preview {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      border: 1px solid #eee;
      background: #f5f5f5;
    }

    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-preview:hover::after {
      content: 'üîç';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.5);
      color: white;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    /* IMAGE MODAL */
    .image-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .image-modal.active {
      display: flex;
    }

    .image-modal-content {
      position: relative;
      width: 90%;
      max-width: 800px;
      max-height: 90%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .image-modal img {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
      border-radius: 8px;
    }

    .image-modal-close {
      position: absolute;
      top: -40px;
      right: 0;
      background: none;
      border: none;
      color: white;
      font-size: 30px;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-modal-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 30px;
      cursor: pointer;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .image-modal-nav:hover {
      background: rgba(255,255,255,0.3);
    }

    .image-modal-nav.prev {
      left: 20px;
    }

    .image-modal-nav.next {
      right: 20px;
    }

    .image-modal-counter {
      color: white;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
      background: rgba(0,0,0,0.5);
      padding: 4px 12px;
      border-radius: 12px;
    }

    /* IMAGE INPUT STYLES */
    .image-input-group {
      margin: 12px 0;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .image-input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .image-input-row input {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .image-input-row button {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      white-space: nowrap;
    }

    .image-preview-small {
      width: 60px;
      height: 60px;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 8px;
      background: #f5f5f5;
    }

    .image-preview-small img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .property-input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
      margin-bottom: 4px;
    }

    .add-property-btn {
      background: none;
      border: none;
      color: #666;
      font-size: 12px;
      cursor: pointer;
      padding: 4px 0;
      text-align: left;
      margin-top: 8px;
    }

    .edit-mode .add-property-btn {
      background: #f0f0f0;
      border: 1px dashed #ccc;
      border-radius: 6px;
      padding: 8px;
      text-align: center;
      width: 100%;
      margin-top: 12px;
    }

    input.edit-input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }

    .form-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    .form-actions button {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: none;
      font-weight: 500;
      cursor: pointer;
      font-size: 14px;
    }

    .save-btn {
      background: var(--button-bg);
      color: #fff;
    }

    .cancel-btn {
      background: #eee;
      color: #333;
    }

    /* SIDEBAR */
    .sidebar {
      position: fixed;
      top: var(--header-height);
      left: -1000px;
      width: var(--sidebar-width);
      bottom: 0;
      background: var(--sidebar-bg);
      padding: 20px;
      overflow-y: auto;
      box-sizing: border-box;
      transition: left .3s ease;
      box-shadow: 4px 0 12px rgba(0,0,0,.15);
      z-index: 300;
    }

    .sidebar.active { left: 0; }

    h3 { margin-top: 0; font-size: 16px; }
    .section { margin-top: 18px; }
    .section-title { font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; }
    .section-content { display: none; margin-top: 10px; }
    .section.active .section-content { display: block; }
    label { font-size: 13px; display: block; margin-top: 10px; }
    input { width: 100%; padding: 8px; margin-top: 4px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
    .btn { width: 100%; margin-top: 10px; padding: 10px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: #eee; }
    .btn.primary { background: var(--button-bg); color: #fff; }
    .btn.danger { background: var(--danger); color: #fff; }
    .btn.warning { background: var(--warning); color: #fff; }
    .btn.success { background: var(--success); color: #fff; }

    /* MODE TABS IN SIDEBAR */
    .mode-tabs {
      display: flex;
      border-radius: 8px;
      background: rgba(0,0,0,0.05);
      padding: 4px;
      margin: 15px 0;
    }

    .mode-tab {
      flex: 1;
      padding: 8px 12px;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
      transition: all 0.2s;
      border-radius: 6px;
      text-align: center;
    }

    .mode-tab.active {
      background: rgba(0,0,0,0.1);
      color: var(--accent);
    }

    .mode-content {
      display: none;
    }

    .mode-content.active {
      display: block;
    }

    /* SELECTOR CONTENT STYLES */
    .selector-actions {
      margin: 15px 0;
    }

    .load-repos-btn {
      width: 100%;
      padding: 10px;
      background: var(--button-bg);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
      margin-bottom: 10px;
    }

    .load-repos-btn:hover:not(:disabled) {
      background: #333;
    }

    .load-repos-btn:disabled {
      background: var(--muted);
      cursor: not-allowed;
      opacity: 0.7;
    }

    .load-repos-btn.loading {
      position: relative;
      color: transparent;
    }

    .load-repos-btn.loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* STATUS MESSAGES */
    .status-message {
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 13px;
      margin: 10px 0;
      display: none;
    }

    .status-message.success {
      display: block;
      background: rgba(76, 175, 80, 0.1);
      color: var(--success);
      border-left: 3px solid var(--success);
    }

    .status-message.error {
      display: block;
      background: rgba(229, 57, 53, 0.1);
      color: var(--danger);
      border-left: 3px solid var(--danger);
    }

    .status-message.loading {
      display: block;
      background: rgba(33, 150, 243, 0.1);
      color: #2196f3;
      border-left: 3px solid #2196f3;
    }

    /* STATS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin: 15px 0;
    }

    .stat-item {
      background: rgba(0,0,0,0.05);
      padding: 10px;
      border-radius: 6px;
      text-align: center;
    }

    .stat-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--accent);
      display: block;
    }

    .stat-label {
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* REPOSITORY BROWSER */
    .repo-browser {
      background: var(--panel);
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.1);
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
    }

    .browser-header {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      background: var(--panel);
      z-index: 1;
    }

    .browser-title {
      font-weight: 600;
      font-size: 13px;
    }

    .browser-subtitle {
      color: var(--muted);
      font-size: 11px;
      margin-top: 2px;
    }

    .selected-path {
      font-size: 11px;
      color: var(--accent);
      font-weight: 500;
      word-break: break-all;
      margin-top: 2px;
      padding: 4px;
      background: rgba(0,0,0,0.05);
      border-radius: 4px;
    }

    .repo-tree {
      padding: 12px;
    }

    .tree-node {
      margin: 2px 0;
      font-size: 12px;
    }

    .tree-content {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 6px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      user-select: none;
    }

    .tree-content:hover {
      background: rgba(0,0,0,0.05);
    }

    .tree-content.selected {
      background: rgba(0,0,0,0.1);
      color: var(--accent);
    }

    .tree-icon {
      width: 12px;
      height: 12px;
      flex-shrink: 0;
      opacity: 0.7;
    }

    .tree-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .tree-arrow {
      width: 10px;
      height: 10px;
      opacity: 0.5;
      transition: transform 0.2s;
    }

    .tree-node.open > .tree-content > .tree-arrow {
      transform: rotate(90deg);
    }

    .tree-children {
      padding-left: 16px;
      display: none;
    }

    .tree-node.open > .tree-children {
      display: block;
    }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 30px 15px;
      color: var(--muted);
    }

    .empty-icon {
      font-size: 24px;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    /* OVERLAY */
    .overlay {
      position: fixed;
      top: var(--header-height);
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,.3);
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s ease;
      z-index: 250;
    }

    .overlay.active { opacity: 1; pointer-events: auto; }

    /* LOADING */
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--muted);
    }

    /* EDIT MODE STYLES */
    .edit-mode-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px dashed #eee;
    }

    .edit-mode-section h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: #666;
    }

    .edit-buttons-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .edit-buttons-row button {
      flex: 1;
      padding: 6px;
      border-radius: 6px;
      border: 1px dashed #ccc;
      background: #f9f9f9;
      color: #666;
      font-size: 12px;
      cursor: pointer;
    }

    /* SCROLLABLE CARD CONTAINER */
    #cardContainer {
      max-height: calc(100vh - 180px);
      overflow-y: auto;
      padding-bottom: 20px;
    }

    /* UPLOAD INDICATOR */
    .upload-indicator {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--button-bg);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 500;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* NO RESULTS MESSAGE */
    .no-results {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-style: italic;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .repo-browser {
        max-height: 250px;
      }
    }
  </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-left">
    <button onclick="toggleSidebar()">‚ò∞</button>
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Cari konten..." onkeyup="filterCards()">
      <button onclick="clearSearch()">‚úï</button>
    </div>
  </div>
</div>

<!-- IMAGE MODAL -->
<div class="image-modal" id="imageModal">
  <div class="image-modal-content">
    <button class="image-modal-close" onclick="closeImageModal()">√ó</button>
    <button class="image-modal-nav prev" onclick="prevImage()">‚Äπ</button>
    <img id="modalImage" src="" alt="Preview Gambar">
    <button class="image-modal-nav next" onclick="nextImage()">‚Ä∫</button>
    <div class="image-modal-counter" id="imageCounter"></div>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <h3>Pengaturan</h3>
  
  <!-- Github Section -->
  <div class="section active">
    <div class="section-title" onclick="toggleSection(this)">Github <span>üîΩ</span></div>
    <div class="section-content">
      <label>PAT (Personal Access Token)</label>
      <input id="pat" placeholder="e.g gh_" />
      
      <small style="color: #666; display: block; margin-top: 5px; font-size: 12px;">
        CATATAN: Jika tidak menggunakan PAT, maka Username wajib diisi (hanya bisa baca data).
      </small>
      
      <!-- Mode Tabs (Ketik | Browse) -->
      <div class="mode-tabs">
        <button class="mode-tab active" data-mode="type">Ketik</button>
        <button class="mode-tab" data-mode="browse">Browse</button>
      </div>
      
      <!-- Ketik Mode Content -->
      <div class="mode-content active" id="typeContent">
        <label>Username</label>
        <input id="username" placeholder="e.g doodz" />
        
        <label>Jalur Repositori</label>
        <input id="repoPath" placeholder="e.g storage" />
        
        <label>Jalur File</label>
        <input id="filePath" placeholder="e.g data/data.json" />
      </div>
      
      <!-- Browse Mode Content -->
      <div class="mode-content" id="browseContent">
        <div class="selector-actions">
          <button class="load-repos-btn" id="loadReposBtn">
            Load Repositories
          </button>
          
          <div class="status-message" id="browseStatus"></div>
          
          <div class="stats-grid" id="browseStats" style="display: none;">
            <div class="stat-item">
              <span class="stat-value" id="repoCount">0</span>
              <span class="stat-label">Repos</span>
            </div>
            <div class="stat-item">
              <span class="stat-value" id="folderCount">0</span>
              <span class="stat-label">Folder</span>
            </div>
            <div class="stat-item">
              <span class="stat-value" id="fileCount">0</span>
              <span class="stat-label">File</span>
            </div>
          </div>
          
          <div class="repo-browser" id="repoBrowser" style="display: none;">
            <div class="browser-header">
              <div class="browser-title">Repository Browser</div>
              <div class="selected-path" id="selectedPath">Selected: -</div>
            </div>
            <div class="repo-tree" id="repoTree">
              <!-- Tree akan dimuat di sini -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Data Offline -->
  <div class="section">
    <div class="section-title" onclick="toggleSection(this)">Data Offline <span>üîΩ</span></div>
    <div class="section-content">
      <button class="btn primary" onclick="uploadToGithub()">Unggah ke Github</button>
      <button class="btn" onclick="downloadOfflineData()">Unduh Data</button>
      <button class="btn danger" onclick="confirmResetOffline()">Reset</button>
    </div>
  </div>
  
  <!-- Data Online -->
  <div class="section">
    <div class="section-title" onclick="toggleSection(this)">Data Online <span>üîΩ</span></div>
    <div class="section-content">
      <button class="btn" onclick="saveOnlineToOffline()">Simpan ke Offline</button>
      <button class="btn" onclick="loadOnline(true)">Reload</button>
    </div>
  </div>
  
  <!-- Antar Muka -->
  <div class="section">
    <div class="section-title" onclick="toggleSection(this)">Antar Muka <span>üîΩ</span></div>
    <div class="section-content">
      <button class="btn warning" onclick="toggleDarkMode()">Toggle Dark Mode</button>
      <button class="btn" onclick="confirmResetSettings()">Reset Pengaturan</button>
    </div>
  </div>
</div>

<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<!-- UPLOAD INDICATOR -->
<div class="upload-indicator" id="uploadIndicator">
  Mengunggah ke GitHub...
</div>

<!-- TAB -->
<div class="tab-container">
  <div class="tab-wrapper">
    <div class="tab" onclick="switchTab(this)" data-tab="Online">Online</div>
    <div class="tab" onclick="switchTab(this)" data-tab="Offline">Offline</div>
  </div>
  <button id="addContentBtn">Tambahkan Konten</button>
  <div id="cardContainer"></div>
</div>

<script>
// ======================== MAIN APP VARIABLES ========================
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const addBtn = document.getElementById('addContentBtn');
const cardContainer = document.getElementById('cardContainer');
const tabs = document.querySelectorAll('.tab');
const uploadIndicator = document.getElementById('uploadIndicator');
const searchInput = document.getElementById('searchInput');
const imageModal = document.getElementById('imageModal');
const modalImage = document.getElementById('modalImage');
const imageCounter = document.getElementById('imageCounter');

// Main app data
let dataOffline = JSON.parse(localStorage.getItem('data_offline') || '[]');
let dataOnline = [];
let onlineSHA = '';
let isEditMode = false;
let currentEditCardId = null;
let currentEditMode = null;
let currentSearchQuery = '';
let currentModalImages = [];
let currentModalIndex = 0;
let currentModalCardId = null;

// ======================== GITHUB BROWSE VARIABLES ========================
const modeTabs = document.querySelectorAll('.mode-tab');
const modeContents = document.querySelectorAll('.mode-content');
const loadReposBtn = document.getElementById('loadReposBtn');
const browseStatus = document.getElementById('browseStatus');
const browseStats = document.getElementById('browseStats');
const repoCount = document.getElementById('repoCount');
const folderCount = document.getElementById('folderCount');
const fileCount = document.getElementById('fileCount');
const repoBrowser = document.getElementById('repoBrowser');
const repoTree = document.getElementById('repoTree');
const selectedPath = document.getElementById('selectedPath');

// Input elements for Ketik mode
const usernameInput = document.getElementById('username');
const repoPathInput = document.getElementById('repoPath');
const filePathInput = document.getElementById('filePath');

// GitHub browse state
let repositories = [];
let currentBrowseMode = 'type';
let lastSelectedPath = '-';

// ======================== MAIN APP FUNCTIONS ========================

// --- Sidebar ---
function toggleSidebar() {
  sidebar.classList.toggle('active');
  overlay.classList.toggle('active');
}

function toggleSection(el) { 
  el.parentElement.classList.toggle('active'); 
}

// --- Search Functionality ---
function filterCards() {
  currentSearchQuery = searchInput.value.toLowerCase().trim();
  const activeTab = document.querySelector('.tab.active').dataset.tab;
  renderCards(activeTab.toLowerCase());
}

function clearSearch() {
  searchInput.value = '';
  filterCards();
}

function searchInCard(card, query) {
  if (!query) return true;
  
  // Search in title
  if (card.title && card.title.toLowerCase().includes(query)) {
    return true;
  }
  
  // Search in info
  if (card.info && Array.isArray(card.info)) {
    for (let info of card.info) {
      if (info.toLowerCase().includes(query)) return true;
    }
  }
  
  // Search in tags
  if (card.tags && Array.isArray(card.tags)) {
    for (let tag of card.tags) {
      if (tag.toLowerCase().includes(query)) return true;
    }
  }
  
  // Search in links
  if (card.links && Array.isArray(card.links)) {
    for (let link of card.links) {
      if (link.toLowerCase().includes(query)) return true;
    }
  }
  
  return false;
}

// --- Tabs ---
function switchTab(el) {
  tabs.forEach(t => t.classList.remove('active'));
  el.classList.add('active');

  const tab = el.dataset.tab;
  if (tab === "Offline") {
    addBtn.style.display = "block";
    addBtn.textContent = "Tambahkan Konten (Offline)";
    addBtn.onclick = () => addNewCard('offline');
    renderCards('offline');
  } else {
    addBtn.style.display = "block";
    addBtn.textContent = "Tambahkan Konten (Online)";
    addBtn.onclick = () => addNewCard('online');
    loadOnline(true);
  }
}

// --- Github Settings ---
const settingsInputs = ['pat','username','repoPath','filePath'];
settingsInputs.forEach(id => {
  const el = document.getElementById(id);
  el.value = localStorage.getItem('setting_' + id) || '';
  el.addEventListener('input', () => {
    localStorage.setItem('setting_' + id, el.value);
    // Sync with browse mode
    if (currentBrowseMode === 'browse' && id === 'pat' && el.value.trim()) {
      setTimeout(() => loadRepositories(), 500);
    }
    // Sync selected path display
    if (id === 'repoPath' || id === 'filePath') {
      updateSelectedPathFromSettings();
    }
  });
});

// Update selected path from settings
function updateSelectedPathFromSettings() {
  const repoPath = repoPathInput.value.trim();
  const filePath = filePathInput.value.trim();
  
  if (repoPath && filePath) {
    lastSelectedPath = `${repoPath}/${filePath}`;
    selectedPath.textContent = `Selected: ${lastSelectedPath}`;
  } else {
    lastSelectedPath = '-';
    selectedPath.textContent = 'Selected: -';
  }
}

// --- Image Modal Functions ---
function openImageModal(cardId, imageIndex) {
  const data = document.querySelector('.tab.active').dataset.tab === 'Offline' ? dataOffline : dataOnline;
  const card = data.find(c => c.id.toString() === cardId.toString());
  
  if (!card || !card.images || card.images.length === 0) return;
  
  currentModalImages = card.images;
  currentModalIndex = imageIndex;
  currentModalCardId = cardId;
  
  showImageInModal(imageIndex);
  imageModal.classList.add('active');
  
  // Update counter
  updateImageCounter();
}

function showImageInModal(index) {
  if (index < 0 || index >= currentModalImages.length) return;
  
  const image = currentModalImages[index];
  let imageUrl = '';
  
  // Get image source from either url or base64
  if (image['images-url'] && image['images-url'].trim() !== '') {
    imageUrl = image['images-url'];
  } else if (image['images-base64'] && image['images-base64'].trim() !== '') {
    // Handle base64 data
    const base64 = image['images-base64'];
    if (base64.startsWith('data:image')) {
      imageUrl = base64;
    } else {
      imageUrl = 'data:image/png;base64,' + base64;
    }
  }
  
  if (imageUrl) {
    modalImage.src = imageUrl;
    modalImage.alt = `Image ${index + 1}`;
    currentModalIndex = index;
    updateImageCounter();
  }
}

function updateImageCounter() {
  if (currentModalImages.length > 0) {
    imageCounter.textContent = `${currentModalIndex + 1} / ${currentModalImages.length}`;
  } else {
    imageCounter.textContent = '';
  }
}

function prevImage() {
  if (currentModalImages.length === 0) return;
  let newIndex = currentModalIndex - 1;
  if (newIndex < 0) newIndex = currentModalImages.length - 1;
  showImageInModal(newIndex);
}

function nextImage() {
  if (currentModalImages.length === 0) return;
  let newIndex = currentModalIndex + 1;
  if (newIndex >= currentModalImages.length) newIndex = 0;
  showImageInModal(newIndex);
}

function closeImageModal() {
  imageModal.classList.remove('active');
  modalImage.src = '';
  currentModalImages = [];
  currentModalIndex = 0;
  currentModalCardId = null;
}

// --- Fungsi Unduh Data Offline ---
function downloadOfflineData() {
  if (dataOffline.length === 0) {
    alert('Tidak ada data offline untuk diunduh.');
    return;
  }
  
  const dataStr = JSON.stringify(dataOffline, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  
  const link = document.createElement('a');
  link.href = url;
  link.download = 'data-offline-' + new Date().toISOString().split('T')[0] + '.json';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  alert('Data offline berhasil diunduh.');
}

// --- Fungsi Unggah ke GitHub ---
async function uploadToGithub() {
  // Validasi input
  const pat = localStorage.getItem('setting_pat') || '';
  const username = localStorage.getItem('setting_username') || '';
  const repoPath = localStorage.getItem('setting_repoPath') || '';
  const filePath = localStorage.getItem('setting_filePath') || '';
  
  // Validasi: jika tidak ada PAT, maka username wajib diisi
  if (!pat && !username) {
    alert('Gagal: Jika tidak menggunakan PAT, maka Username wajib diisi!');
    return;
  }
  
  // Validasi: repoPath dan filePath wajib diisi
  if (!repoPath || !filePath) {
    alert('Gagal: Jalur Repositori dan Jalur File wajib diisi!');
    return;
  }
  
  // Validasi: ada data offline
  if (dataOffline.length === 0) {
    alert('Tidak ada data offline untuk diunggah.');
    return;
  }
  
  try {
    // Persiapan data
    const content = JSON.stringify(dataOffline, null, 2);
    const encodedContent = btoa(unescape(encodeURIComponent(content)));
    
    // Cek apakah file sudah ada
    const owner = username || await getUsernameFromPAT(pat);
    const repo = repoPath.split('/')[0];
    const path = filePath;
    
    const checkUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
    const headers = {
      "Accept": "application/vnd.github.v3+json",
      "Authorization": pat ? `Bearer ${pat}` : undefined
    };
    
    if (!pat) delete headers.Authorization;
    
    let sha = '';
    let fileExists = false;
    
    try {
      const checkRes = await fetch(checkUrl, { headers });
      if (checkRes.ok) {
        const fileData = await checkRes.json();
        sha = fileData.sha;
        fileExists = true;
      }
    } catch (e) {
      // File belum ada
      fileExists = false;
    }
    
    // Tampilkan konfirmasi yang sesuai
    const action = fileExists ? 'OVERWRITE' : 'BUAT BARU';
    const message = fileExists 
      ? `File sudah ada di GitHub. Ingin mengganti dengan data offline? (${dataOffline.length} item)` 
      : `Buat file baru di GitHub dengan data offline? (${dataOffline.length} item)`;
    
    if (!confirm(`${message}\n\nAksi: ${action}`)) {
      return;
    }
    
    // Data untuk upload
    const uploadData = {
      message: `${action === 'BUAT BARU' ? 'Create' : 'Update'} data offline - ${new Date().toLocaleString()}`,
      content: encodedContent,
      ...(sha && { sha: sha })
    };
    
    const uploadUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
    const uploadRes = await fetch(uploadUrl, {
      method: 'PUT',
      headers: headers,
      body: JSON.stringify(uploadData)
    });
    
    if (uploadRes.ok) {
      const result = await uploadRes.json();
      alert(`Data berhasil di${action === 'BUAT BARU' ? 'unggah' : 'perbarui'} ke GitHub!\nAksi: ${action}\nCommit: ${result.commit.sha.substring(0, 7)}`);
    } else {
      const error = await uploadRes.text();
      throw new Error(`Upload gagal: ${uploadRes.status} - ${error}`);
    }
    
  } catch (error) {
    console.error('Error uploading to GitHub:', error);
    alert('Gagal mengunggah ke GitHub: ' + error.message);
  }
}

// Fungsi untuk mendapatkan username dari PAT
async function getUsernameFromPAT(pat) {
  if (!pat) return '';
  
  try {
    const response = await fetch('https://api.github.com/user', {
      headers: {
        'Authorization': `Bearer ${pat}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (response.ok) {
      const userData = await response.json();
      return userData.login;
    }
  } catch (e) {
    console.error('Error getting username from PAT:', e);
  }
  
  return '';
}

function confirmResetOffline() {
  if(confirm('Reset Data Offline? Lanjutkan?')) {
    dataOffline = [];
    localStorage.removeItem('data_offline');
    renderCards('offline');
    alert('Data offline dihapus');
  }
}

function confirmResetSettings() {
  if(confirm('Reset Pengaturan? Lanjutkan?')) {
    settingsInputs.forEach(id => localStorage.removeItem('setting_' + id));
    settingsInputs.forEach(id => document.getElementById(id).value = '');
    localStorage.removeItem('setting_browseMode');
    alert('Pengaturan direset');
  }
}

// --- Tambah Konten Baru ---
function addNewCard(mode) {
  const newCard = { 
    id: Date.now(), 
    title: 'Judul Konten Baru',
    info: [],
    tags: [],
    links: [],
    images: []
  };
  
  if (mode === 'offline') {
    dataOffline.push(newCard);
    saveDataOffline();
    renderCards('offline');
    alert('Konten baru ditambahkan ke data offline (disimpan di localStorage)');
  } else {
    dataOnline.push(newCard);
    // Langsung upload ke GitHub untuk konten baru di mode online
    showUploadIndicator();
    uploadOnlineToGithub()
      .then(() => {
        hideUploadIndicator();
        renderCards('online');
      })
      .catch(error => {
        hideUploadIndicator();
        alert('Gagal menambahkan konten baru: ' + error.message);
        // Hapus dari dataOnline jika gagal upload
        dataOnline = dataOnline.filter(c => c.id !== newCard.id);
        renderCards('online');
      });
  }
}

function saveDataOffline() {
  localStorage.setItem('data_offline', JSON.stringify(dataOffline));
}

// --- LOAD DATA ONLINE DARI GITHUB ---
async function loadOnline(forceReload = false) {
  cardContainer.innerHTML = '<div class="loading">Memuat data online...</div>';
  
  const pat = localStorage.getItem('setting_pat') || '';
  const username = localStorage.getItem('setting_username') || '';
  const repoPath = localStorage.getItem('setting_repoPath') || '';
  const filePath = localStorage.getItem('setting_filePath') || '';
  
  if (!pat && !username) {
    showError("Untuk melihat data online, isi Username (wajib jika tanpa PAT) atau PAT.");
    return;
  }
  
  if (!repoPath || !filePath) {
    showError("Pengaturan GitHub belum lengkap.");
    return;
  }
  
  const owner = username || await getUsernameFromPAT(pat);
  const repo = repoPath.split('/')[0];
  const path = filePath;
  
  try {
    const headers = { 
      "Accept": "application/vnd.github.v3+json"
    };
    if (pat) headers["Authorization"] = `Bearer ${pat}`;
    
    const rawUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
    const res = await fetch(rawUrl, { headers });
    
    if (!res.ok) {
      if (res.status === 404) {
        showError("File tidak ditemukan di repository.");
        return;
      }
      throw new Error(`Gagal memuat: ${res.status} ${res.statusText}`);
    }
    
    const fileData = await res.json();
    onlineSHA = fileData.sha;
    
    try {
      const content = atob(fileData.content.replace(/\s/g, ''));
      dataOnline = JSON.parse(content);
      
      if (!Array.isArray(dataOnline)) {
        throw new Error("Data bukan array");
      }
      
      // Pastikan setiap item memiliki properti dasar termasuk images
      dataOnline = dataOnline.map(item => ({
        id: item.id || Date.now() + Math.random(),
        title: item.title || 'Tanpa Judul',
        info: Array.isArray(item.info) ? item.info : [],
        tags: Array.isArray(item.tags) ? item.tags : [],
        links: Array.isArray(item.links) ? item.links : [],
        images: Array.isArray(item.images) ? item.images : []
      }));
      
      renderCards('online');
      
    } catch (parseError) {
      console.error('Parse error:', parseError);
      showError("Format data tidak valid: " + parseError.message);
    }
    
  } catch (err) {
    console.error('Error loading online data:', err);
    showError("Gagal Memuat: " + err.message);
  }
}

function showError(msg) {
  cardContainer.innerHTML = `
    <div style="padding: 20px; text-align: center; background: #fff; border-radius: 12px; margin: 8px auto; max-width: 320px;">
      <p style="color:red; margin: 0 0 10px 0;">${msg}</p>
      <button onclick="loadOnline(true)" style="padding: 8px 16px; background: #111; color: #fff; border: none; border-radius: 6px; cursor: pointer;">Coba Lagi</button>
    </div>
  `;
}

// --- SIMPAN DATA ONLINE KE OFFLINE ---
function saveOnlineToOffline() {
  if (dataOnline.length === 0) {
    alert('Tidak ada data online untuk disimpan.');
    return;
  }
  
  dataOffline = JSON.parse(JSON.stringify(dataOnline));
  saveDataOffline();
  alert(`Data online berhasil disimpan ke offline (${dataOffline.length} item)`);
}

// --- UPLOAD DATA ONLINE KE GITHUB ---
async function uploadOnlineToGithub() {
  const pat = localStorage.getItem('setting_pat') || '';
  const username = localStorage.getItem('setting_username') || '';
  const repoPath = localStorage.getItem('setting_repoPath') || '';
  const filePath = localStorage.getItem('setting_filePath') || '';
  
  if (!pat) {
    throw new Error('Diperlukan PAT untuk mengunggah perubahan ke GitHub!');
  }
  
  if (!username && !pat) {
    throw new Error('Username wajib diisi!');
  }
  
  if (!repoPath || !filePath) {
    throw new Error('Jalur Repositori dan Jalur File wajib diisi!');
  }
  
  if (dataOnline.length === 0) {
    throw new Error('Tidak ada data online untuk diunggah.');
  }
  
  const content = JSON.stringify(dataOnline, null, 2);
  const encodedContent = btoa(unescape(encodeURIComponent(content)));
  
  const owner = username || await getUsernameFromPAT(pat);
  const repo = repoPath.split('/')[0];
  const path = filePath;
  
  const uploadData = {
    message: `Update data online - ${new Date().toLocaleString()}`,
    content: encodedContent,
    sha: onlineSHA || undefined
  };
  
  const headers = {
    "Accept": "application/vnd.github.v3+json",
    "Authorization": `Bearer ${pat}`
  };
  
  const uploadUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
  const uploadRes = await fetch(uploadUrl, {
    method: 'PUT',
    headers: headers,
    body: JSON.stringify(uploadData)
  });
  
  if (uploadRes.ok) {
    const result = await uploadRes.json();
    onlineSHA = result.content.sha;
    return result;
  } else {
    const error = await uploadRes.text();
    throw new Error(`Upload gagal: ${uploadRes.status} - ${error}`);
  }
}

// --- UPLOAD INDICATOR FUNCTIONS ---
function showUploadIndicator() {
  uploadIndicator.style.display = 'block';
}

function hideUploadIndicator() {
  uploadIndicator.style.display = 'none';
}

// --- RENDER CARDS ---
function renderCards(mode) {
  const data = mode === 'offline' ? dataOffline : dataOnline;
  cardContainer.innerHTML = '';
  
  if (data.length === 0) {
    const emptyMsg = document.createElement('div');
    emptyMsg.className = 'loading';
    emptyMsg.textContent = mode === 'offline' ? 'Belum ada data offline' : 'Belum ada data online';
    cardContainer.appendChild(emptyMsg);
    return;
  }
  
  // Filter data berdasarkan search query
  let filteredData = data;
  if (currentSearchQuery) {
    filteredData = data.filter(card => searchInCard(card, currentSearchQuery));
  }
  
  if (filteredData.length === 0) {
    const noResults = document.createElement('div');
    noResults.className = 'no-results';
    noResults.textContent = `Tidak ditemukan konten dengan pencarian "${currentSearchQuery}"`;
    cardContainer.appendChild(noResults);
    return;
  }
  
  filteredData.forEach(card => {
    const cardDiv = createCardElement(card, mode);
    cardContainer.appendChild(cardDiv);
  });
}

function createCardElement(card, mode) {
  const div = document.createElement('div');
  div.className = 'card';
  div.dataset.id = card.id;
  
  // Header dengan title dan actions
  const headerDiv = document.createElement('div');
  headerDiv.className = 'card-header';
  
  const titleDiv = document.createElement('div');
  titleDiv.className = 'card-title';
  titleDiv.textContent = card.title || 'Tanpa Judul';
  titleDiv.style.wordBreak = 'break-word';
  
  const actionsDiv = document.createElement('div');
  actionsDiv.className = 'card-actions';
  
  const editBtn = document.createElement('button');
  editBtn.textContent = '‚úçÔ∏è';
  editBtn.title = 'Edit';
  editBtn.onclick = () => startEdit(card.id, mode);
  
  const delBtn = document.createElement('button');
  delBtn.textContent = '‚ùå';
  delBtn.title = 'Hapus';
  delBtn.onclick = () => deleteCard(card.id, mode);
  
  actionsDiv.appendChild(editBtn);
  actionsDiv.appendChild(delBtn);
  
  headerDiv.appendChild(titleDiv);
  headerDiv.appendChild(actionsDiv);
  div.appendChild(headerDiv);
  
  // Properti info (bisa banyak)
  if (card.info && card.info.length > 0) {
    const infoGroup = createPropertyGroup('info', card.info);
    div.appendChild(infoGroup);
  }
  
  // Properti tags (bisa banyak)
  if (card.tags && card.tags.length > 0) {
    const tagsGroup = createPropertyGroup('tags', card.tags);
    div.appendChild(tagsGroup);
  }
  
  // Properti links (bisa banyak)
  if (card.links && card.links.length > 0) {
    const linksGroup = createPropertyGroup('links', card.links);
    div.appendChild(linksGroup);
  }
  
  // Properti images dengan preview
  if (card.images && card.images.length > 0) {
    const imagesGroup = createImagesGroup(card.id, card.images);
    div.appendChild(imagesGroup);
  }
  
  return div;
}

function createPropertyGroup(type, values) {
  const group = document.createElement('div');
  group.className = 'property-group';
  
  const labelDiv = document.createElement('div');
  labelDiv.className = 'property-label';
  
  const label = document.createElement('span');
  label.textContent = type.charAt(0).toUpperCase() + type.slice(1) + ` (${values.length})`;
  
  const toggleBtn = document.createElement('button');
  toggleBtn.className = 'toggle-btn';
  toggleBtn.textContent = 'üîΩ';
  toggleBtn.dataset.expanded = 'false';
  
  toggleBtn.onclick = function() {
    const isExpanded = this.dataset.expanded === 'true';
    this.dataset.expanded = !isExpanded;
    const valuesDiv = this.closest('.property-group').querySelector('.property-values');
    valuesDiv.classList.toggle('vertical', !isExpanded);
    this.textContent = isExpanded ? 'üîΩ' : 'üîº';
  };
  
  labelDiv.appendChild(label);
  if (values.length > 1) labelDiv.appendChild(toggleBtn);
  
  const valuesDiv = document.createElement('div');
  valuesDiv.className = 'property-values';
  if (values.length > 3) {
    valuesDiv.classList.add('horizontal');
  }
  
  values.forEach(value => {
    const valueDiv = document.createElement('div');
    valueDiv.className = 'property-value';
    valueDiv.textContent = value;
    valueDiv.title = value;
    valuesDiv.appendChild(valueDiv);
  });
  
  group.appendChild(labelDiv);
  group.appendChild(valuesDiv);
  
  return group;
}

function createImagesGroup(cardId, images) {
  const group = document.createElement('div');
  group.className = 'property-group';
  
  const labelDiv = document.createElement('div');
  labelDiv.className = 'property-label';
  
  const label = document.createElement('span');
  label.textContent = `Images (${images.length})`;
  
  const toggleBtn = document.createElement('button');
  toggleBtn.className = 'toggle-btn';
  toggleBtn.textContent = 'üîΩ';
  toggleBtn.dataset.expanded = 'false';
  
  toggleBtn.onclick = function() {
    const isExpanded = this.dataset.expanded === 'true';
    this.dataset.expanded = !isExpanded;
    const previewContainer = this.closest('.property-group').querySelector('.image-preview-container');
    previewContainer.style.display = isExpanded ? 'none' : 'flex';
    this.textContent = isExpanded ? 'üîΩ' : 'üîº';
  };
  
  labelDiv.appendChild(label);
  if (images.length > 1) labelDiv.appendChild(toggleBtn);
  
  const previewContainer = document.createElement('div');
  previewContainer.className = 'image-preview-container';
  
  images.forEach((image, index) => {
    let imageUrl = '';
    
    // Cek apakah image berupa object dengan properties atau string langsung
    if (typeof image === 'object') {
      // Prioritaskan URL, jika tidak ada gunakan base64
      if (image['images-url'] && image['images-url'].trim() !== '') {
        imageUrl = image['images-url'];
      } else if (image['images-base64'] && image['images-base64'].trim() !== '') {
        // Handle base64 data untuk thumbnail
        const base64 = image['images-base64'];
        if (base64.startsWith('data:image')) {
          imageUrl = base64;
        } else {
          imageUrl = 'data:image/png;base64,' + base64;
        }
      }
    } else {
      // Jika image adalah string langsung
      imageUrl = image;
    }
    
    if (imageUrl) {
      const previewDiv = document.createElement('div');
      previewDiv.className = 'image-preview';
      previewDiv.onclick = () => openImageModal(cardId, index);
      
      const img = document.createElement('img');
      img.src = imageUrl;
      img.alt = `Image ${index + 1}`;
      img.onerror = function() {
        this.style.display = 'none';
        previewDiv.innerHTML = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#eee;color:#666;">‚ùå</div>';
      };
      img.onload = function() {
        // Set background color to transparent when image loads successfully
        previewDiv.style.background = 'transparent';
      };
      
      previewDiv.appendChild(img);
      previewContainer.appendChild(previewDiv);
    }
  });
  
  group.appendChild(labelDiv);
  group.appendChild(previewContainer);
  
  return group;
}

// --- EDIT CARD ---
function startEdit(id, mode) {
  isEditMode = true;
  currentEditCardId = id;
  currentEditMode = mode;
  
  const data = mode === 'offline' ? dataOffline : dataOnline;
  const cardIndex = data.findIndex(c => c.id === id);
  if(cardIndex === -1) return;
  
  const card = data[cardIndex];
  
  const cardDiv = document.querySelector(`.card[data-id="${id}"]`);
  if (!cardDiv) return;
  
  cardDiv.innerHTML = '';
  cardDiv.classList.add('edit-mode');
  
  // Form edit
  const form = document.createElement('form');
  form.onsubmit = (e) => {
    e.preventDefault();
    saveEdit(id, mode);
  };
  
  // Title
  const titleLabel = document.createElement('label');
  titleLabel.textContent = 'Judul';
  titleLabel.style.display = 'block';
  titleLabel.style.marginBottom = '4px';
  titleLabel.style.fontSize = '12px';
  titleLabel.style.color = '#666';
  
  const titleInput = document.createElement('input');
  titleInput.className = 'edit-input';
  titleInput.value = card.title || '';
  titleInput.required = true;
  titleInput.placeholder = 'Masukkan judul';
  
  form.appendChild(titleLabel);
  form.appendChild(titleInput);
  
  // Edit existing properties
  const properties = [
    { key: 'info', label: 'Info', placeholder: 'Masukkan info' },
    { key: 'tags', label: 'Tags', placeholder: 'Masukkan tag' },
    { key: 'links', label: 'Links', placeholder: 'Masukkan link' }
  ];
  
  properties.forEach(prop => {
    const propLabel = document.createElement('label');
    propLabel.textContent = prop.label;
    propLabel.style.display = 'block';
    propLabel.style.marginBottom = '4px';
    propLabel.style.marginTop = '16px';
    propLabel.style.fontSize = '12px';
    propLabel.style.color = '#666';
    propLabel.style.fontWeight = '600';
    
    form.appendChild(propLabel);
    
    if (!card[prop.key]) {
      card[prop.key] = [];
    }
    
    if (card[prop.key].length > 0) {
      card[prop.key].forEach((value, index) => {
        createPropertyInput(form, prop.key, value, index, card, prop.placeholder);
      });
    } else {
      createPropertyInput(form, prop.key, '', 0, card, prop.placeholder);
    }
  });
  
  // Images Section
  const imagesLabel = document.createElement('label');
  imagesLabel.textContent = 'Images';
  imagesLabel.style.display = 'block';
  imagesLabel.style.marginBottom = '4px';
  imagesLabel.style.marginTop = '16px';
  imagesLabel.style.fontSize = '12px';
  imagesLabel.style.color = '#666';
  imagesLabel.style.fontWeight = '600';
  
  form.appendChild(imagesLabel);
  
  if (!card.images) {
    card.images = [];
  }
  
  // Display existing images
  const imagesContainer = document.createElement('div');
  imagesContainer.id = 'imagesContainer_' + id;
  
  card.images.forEach((image, index) => {
    const imageGroup = createImageInputGroup(id, index, image, card);
    imagesContainer.appendChild(imageGroup);
  });
  
  form.appendChild(imagesContainer);
  
  // Add image button
  const addImageBtn = document.createElement('button');
  addImageBtn.type = 'button';
  addImageBtn.className = 'add-property-btn';
  addImageBtn.textContent = '+ Tambah Gambar';
  addImageBtn.style.marginTop = '12px';
  addImageBtn.onclick = () => {
    const newIndex = card.images.length;
    card.images.push({ 'images-url': '', 'images-base64': '' });
    const imageGroup = createImageInputGroup(id, newIndex, { 'images-url': '', 'images-base64': '' }, card);
    imagesContainer.appendChild(imageGroup);
    
    // Scroll to new image input
    setTimeout(() => {
      imageGroup.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
  };
  
  form.appendChild(addImageBtn);
  
  // Section untuk menambah properti baru
  const addSection = document.createElement('div');
  addSection.className = 'edit-mode-section';
  
  const addTitle = document.createElement('h4');
  addTitle.textContent = 'Tambah Item Baru';
  addSection.appendChild(addTitle);
  
  const addButtonsRow = document.createElement('div');
  addButtonsRow.className = 'edit-buttons-row';
  
  const addInfoBtn = document.createElement('button');
  addInfoBtn.type = 'button';
  addInfoBtn.textContent = '+ Tambah Info';
  addInfoBtn.onclick = () => {
    const newIndex = card.info.length;
    card.info.push('');
    createPropertyInput(form, 'info', '', newIndex, card, 'Masukkan info', true);
  };
  
  const addTagBtn = document.createElement('button');
  addTagBtn.type = 'button';
  addTagBtn.textContent = '+ Tambah Tag';
  addTagBtn.onclick = () => {
    const newIndex = card.tags.length;
    card.tags.push('');
    createPropertyInput(form, 'tags', '', newIndex, card, 'Masukkan tag', true);
  };
  
  const addLinkBtn = document.createElement('button');
  addLinkBtn.type = 'button';
  addLinkBtn.textContent = '+ Tambah Link';
  addLinkBtn.onclick = () => {
    const newIndex = card.links.length;
    card.links.push('');
    createPropertyInput(form, 'links', '', newIndex, card, 'Masukkan link', true);
  };
  
  addButtonsRow.appendChild(addInfoBtn);
  addButtonsRow.appendChild(addTagBtn);
  addButtonsRow.appendChild(addLinkBtn);
  addSection.appendChild(addButtonsRow);
  
  form.appendChild(addSection);
  
  // Form actions
  const formActions = document.createElement('div');
  formActions.className = 'form-actions';
  
  const saveBtn = document.createElement('button');
  saveBtn.type = 'submit';
  saveBtn.className = 'save-btn';
  saveBtn.textContent = 'Simpan';
  
  const cancelBtn = document.createElement('button');
  cancelBtn.type = 'button';
  cancelBtn.className = 'cancel-btn';
  cancelBtn.textContent = 'Batal';
  cancelBtn.onclick = () => {
    isEditMode = false;
    currentEditCardId = null;
    currentEditMode = null;
    renderCards(mode);
  };
  
  formActions.appendChild(saveBtn);
  formActions.appendChild(cancelBtn);
  form.appendChild(formActions);
  
  cardDiv.appendChild(form);
  
  setTimeout(() => {
    titleInput.focus();
  }, 100);
}

function createImageInputGroup(cardId, index, image, card) {
  const imageGroup = document.createElement('div');
  imageGroup.className = 'image-input-group';
  
  // URL Input
  const urlRow = document.createElement('div');
  urlRow.className = 'image-input-row';
  
  const urlInput = document.createElement('input');
  urlInput.type = 'text';
  urlInput.placeholder = 'URL Gambar';
  urlInput.value = image['images-url'] || image.url || '';
  urlInput.dataset.index = index;
  urlInput.dataset.type = 'url';
  urlInput.oninput = function() {
    card.images[index]['images-url'] = this.value;
    updateImagePreview(cardId, index, this.value, '');
  };
  
  const removeBtn = document.createElement('button');
  removeBtn.type = 'button';
  removeBtn.textContent = 'Hapus';
  removeBtn.onclick = () => {
    card.images.splice(index, 1);
    startEdit(cardId, currentEditMode);
  };
  
  urlRow.appendChild(urlInput);
  urlRow.appendChild(removeBtn);
  imageGroup.appendChild(urlRow);
  
  // Base64 Input
  const base64Row = document.createElement('div');
  base64Row.className = 'image-input-row';
  
  const base64Input = document.createElement('input');
  base64Input.type = 'text';
  base64Input.placeholder = 'Base64 Gambar (opsional)';
  base64Input.value = image['images-base64'] || '';
  base64Input.dataset.index = index;
  base64Input.dataset.type = 'base64';
  base64Input.oninput = function() {
    card.images[index]['images-base64'] = this.value;
    updateImagePreview(cardId, index, '', this.value);
  };
  
  const fileBtn = document.createElement('button');
  fileBtn.type = 'button';
  fileBtn.textContent = 'Upload File';
  fileBtn.onclick = () => uploadImageFile(cardId, index, card);
  
  base64Row.appendChild(base64Input);
  base64Row.appendChild(fileBtn);
  imageGroup.appendChild(base64Row);
  
  // Preview
  const previewDiv = document.createElement('div');
  previewDiv.className = 'image-preview-small';
  previewDiv.id = `imagePreview_${cardId}_${index}`;
  
  // Set initial preview
  if (image['images-url']) {
    updateImagePreview(cardId, index, image['images-url'], '');
  } else if (image['images-base64']) {
    updateImagePreview(cardId, index, '', image['images-base64']);
  }
  
  imageGroup.appendChild(previewDiv);
  
  return imageGroup;
}

function updateImagePreview(cardId, index, url, base64) {
  const previewDiv = document.getElementById(`imagePreview_${cardId}_${index}`);
  if (!previewDiv) return;
  
  previewDiv.innerHTML = '';
  
  let imageSrc = '';
  if (url) {
    imageSrc = url;
  } else if (base64) {
    // Handle base64 data
    if (base64.startsWith('data:image')) {
      imageSrc = base64;
    } else {
      imageSrc = 'data:image/png;base64,' + base64;
    }
  }
  
  if (imageSrc) {
    const img = document.createElement('img');
    img.src = imageSrc;
    img.alt = `Preview ${index}`;
    img.onerror = function() {
      this.style.display = 'none';
      previewDiv.innerHTML = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#eee;color:#666;font-size:12px;">Gagal memuat</div>';
    };
    img.onload = function() {
      previewDiv.style.background = 'transparent';
    };
    previewDiv.appendChild(img);
  } else {
    previewDiv.innerHTML = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#eee;color:#666;font-size:12px;">No image</div>';
  }
}

function uploadImageFile(cardId, index, card) {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      const base64 = event.target.result;
      card.images[index]['images-base64'] = base64;
      
      // Update base64 input
      const base64Input = document.querySelector(`input[data-index="${index}"][data-type="base64"]`);
      if (base64Input) {
        base64Input.value = base64;
      }
      
      updateImagePreview(cardId, index, '', base64);
    };
    
    reader.readAsDataURL(file);
  };
  
  input.click();
}

function createPropertyInput(form, propKey, value, index, card, placeholder, scrollToBottom = false) {
  const valueDiv = document.createElement('div');
  valueDiv.style.display = 'flex';
  valueDiv.style.gap = '4px';
  valueDiv.style.marginBottom = '4px';
  valueDiv.style.alignItems = 'center';
  
  const valueInput = document.createElement('input');
  valueInput.className = 'property-input';
  valueInput.value = value;
  valueInput.dataset.property = propKey;
  valueInput.dataset.index = index;
  valueInput.placeholder = placeholder;
  
  const removeBtn = document.createElement('button');
  removeBtn.type = 'button';
  removeBtn.textContent = '‚ùå';
  removeBtn.style.background = 'none';
  removeBtn.style.border = 'none';
  removeBtn.style.cursor = 'pointer';
  removeBtn.style.padding = '0';
  removeBtn.style.width = '24px';
  removeBtn.style.height = '24px';
  removeBtn.style.display = 'flex';
  removeBtn.style.alignItems = 'center';
  removeBtn.style.justifyContent = 'center';
  removeBtn.onclick = () => {
    card[propKey].splice(index, 1);
    startEdit(currentEditCardId, currentEditMode);
  };
  
  valueDiv.appendChild(valueInput);
  valueDiv.appendChild(removeBtn);
  
  let insertBefore = null;
  const labels = form.querySelectorAll('label');
  for (let label of labels) {
    if (label.textContent.toLowerCase() === propKey.toLowerCase()) {
      let nextSibling = label.nextElementSibling;
      while (nextSibling && 
             !(nextSibling.classList && nextSibling.classList.contains('edit-mode-section'))) {
        if (nextSibling.querySelector && nextSibling.querySelector(`input[data-property="${propKey}"]`)) {
          nextSibling = nextSibling.nextElementSibling;
        } else {
          break;
        }
      }
      if (nextSibling) {
        insertBefore = nextSibling;
      }
      break;
    }
  }
  
  if (insertBefore) {
    form.insertBefore(valueDiv, insertBefore);
  } else {
    const addSection = form.querySelector('.edit-mode-section');
    if (addSection) {
      form.insertBefore(valueDiv, addSection);
    } else {
      form.appendChild(valueDiv);
    }
  }
  
  if (scrollToBottom) {
    setTimeout(() => {
      valueInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      valueInput.focus();
    }, 100);
  }
}

function saveEdit(id, mode) {
  const data = mode === 'offline' ? dataOffline : dataOnline;
  const cardIndex = data.findIndex(c => c.id === id);
  if(cardIndex === -1) return;
  
  const card = data[cardIndex];
  
  // Update title
  const cardDiv = document.querySelector(`.card[data-id="${id}"]`);
  if (!cardDiv) return;
  
  const form = cardDiv.querySelector('form');
  if (!form) return;
  
  const titleInput = form.querySelector('input.edit-input');
  if (titleInput) {
    card.title = titleInput.value.trim();
  }
  
  // Update properti dari semua input
  const propertyInputs = form.querySelectorAll('input[data-property]');
  
  // Reset semua array properti kecuali images
  card.info = [];
  card.tags = [];
  card.links = [];
  
  // Update images dari form
  if (card.images && card.images.length > 0) {
    // Clean images array
    card.images = card.images.filter(img => {
      const hasUrl = img['images-url'] && img['images-url'].trim() !== '';
      const hasBase64 = img['images-base64'] && img['images-base64'].trim() !== '';
      return hasUrl || hasBase64;
    });
  }
  
  // Update info, tags, links
  const groupedInputs = {};
  propertyInputs.forEach(input => {
    const prop = input.dataset.property;
    if (!groupedInputs[prop]) {
      groupedInputs[prop] = [];
    }
    groupedInputs[prop].push({
      index: parseInt(input.dataset.index),
      value: input.value.trim()
    });
  });
  
  Object.keys(groupedInputs).forEach(prop => {
    groupedInputs[prop].sort((a, b) => a.index - b.index);
    
    groupedInputs[prop].forEach(item => {
      if (item.value !== '') {
        card[prop].push(item.value);
      }
    });
  });
  
  // Reset edit mode flags
  isEditMode = false;
  currentEditCardId = null;
  currentEditMode = null;
  
  if (mode === 'offline') {
    saveDataOffline();
    renderCards('offline');
    alert('Perubahan disimpan di data offline (localStorage)');
  } else {
    showUploadIndicator();
    uploadOnlineToGithub()
      .then(() => {
        hideUploadIndicator();
        renderCards('online');
      })
      .catch(error => {
        hideUploadIndicator();
        alert('Gagal mengunggah perubahan: ' + error.message);
        renderCards('online');
      });
  }
}

// --- DELETE CARD ---
function deleteCard(id, mode) {
  if (!confirm('Hapus konten ini?')) return;
  
  if (mode === 'offline') {
    dataOffline = dataOffline.filter(c => c.id !== id);
    saveDataOffline();
    renderCards('offline');
    alert('Konten dihapus dari data offline (localStorage)');
  } else {
    const originalLength = dataOnline.length;
    dataOnline = dataOnline.filter(c => c.id !== id);
    
    if (dataOnline.length < originalLength) {
      showUploadIndicator();
      uploadOnlineToGithub()
        .then(() => {
          hideUploadIndicator();
          renderCards('online');
        })
        .catch(error => {
          hideUploadIndicator();
          alert('Gagal mengunggah perubahan: ' + error.message);
          loadOnline(true);
        });
    } else {
      renderCards('online');
    }
  }
}

// ======================== GITHUB BROWSE FUNCTIONS ========================

// Set active mode (Ketik | Browse)
function setBrowseMode(mode) {
  currentBrowseMode = mode;
  
  // Update tab buttons
  modeTabs.forEach(tab => {
    tab.classList.toggle('active', tab.dataset.mode === mode);
  });
  
  // Update content
  modeContents.forEach(content => {
    content.classList.toggle('active', content.id === `${mode}Content`);
  });
  
  // Save mode to settings
  localStorage.setItem('setting_browseMode', mode);
  
  // If switching to browse mode, auto-load if token exists
  if (mode === 'browse') {
    const pat = document.getElementById('pat').value.trim();
    if (pat && repositories.length === 0) {
      setTimeout(() => loadRepositories(), 100);
    }
    // Update selected path from settings
    updateSelectedPathFromSettings();
  } else if (mode === 'type') {
    // When switching to Ketik mode, auto-fill from last selected path
    if (lastSelectedPath && lastSelectedPath !== '-') {
      // Parse the path into repoPath and filePath
      const parts = lastSelectedPath.split('/');
      if (parts.length >= 2) {
        const repo = parts[0];
        const file = parts.slice(1).join('/');
        
        // Update inputs if they're empty or different
        if (!repoPathInput.value.trim() || repoPathInput.value !== repo) {
          repoPathInput.value = repo;
          localStorage.setItem('setting_repoPath', repo);
        }
        
        if (!filePathInput.value.trim() || filePathInput.value !== file) {
          filePathInput.value = file;
          localStorage.setItem('setting_filePath', file);
        }
      }
    }
  }
}

// Show status message in browse
function showBrowseStatus(message, type = 'info') {
  browseStatus.textContent = message;
  browseStatus.className = `status-message ${type}`;
  
  if (type !== 'loading') {
    setTimeout(() => {
      browseStatus.className = 'status-message';
      browseStatus.textContent = '';
    }, 3000);
  }
}

// Update stats display in browse
function updateBrowseStats(repoCountValue, folderCountValue, fileCountValue) {
  repoCount.textContent = repoCountValue;
  folderCount.textContent = folderCountValue;
  fileCount.textContent = fileCountValue;
  browseStats.style.display = 'grid';
}

// Create tree node for repository browser
function createTreeNode(item, depth = 0) {
  const node = document.createElement('div');
  node.className = 'tree-node';
  node.dataset.type = item.type;
  node.dataset.path = item.path || item.name;
  
  if (item.type === 'dir') {
    node.classList.toggle('open', item.open || false);
  }
  
  const content = document.createElement('div');
  content.className = 'tree-content';
  
  let icon = 'üìÑ';
  let arrow = '';
  
  if (item.type === 'dir') {
    icon = item.open ? 'üìÇ' : 'üìÅ';
    arrow = `
      <svg class="tree-arrow" viewBox="0 0 24 24" fill="currentColor">
        <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
      </svg>
    `;
    
    content.onclick = (e) => {
      e.stopPropagation();
      
      if (item.type === 'dir') {
        item.open = !item.open;
        node.classList.toggle('open', item.open);
        
        // Load children if opening for the first time
        if (item.open && (!item.children || item.children.length === 0) && item.url) {
          loadDirectoryContent(item, node);
        }
      }
    };
  } else {
    content.onclick = () => {
      // Select file
      document.querySelectorAll('.tree-content.selected').forEach(el => {
        el.classList.remove('selected');
      });
      content.classList.add('selected');
      
      // Update selected path
      const path = item.path || item.name;
      lastSelectedPath = path;
      selectedPath.textContent = `Selected: ${path}`;
      
      // Show confirmation dialog
      if (confirm(`Pilih file:\n${path}\n\nGunakan path ini di tab Ketik?`)) {
        // Parse the path into repoPath and filePath
        const parts = path.split('/');
        if (parts.length >= 2) {
          const repo = parts[0];
          const file = parts.slice(1).join('/');
          
          // Store for when switching to Ketik mode
          localStorage.setItem('setting_repoPath', repo);
          localStorage.setItem('setting_filePath', file);
          
          showBrowseStatus('Path disimpan. Beralih ke tab Ketik untuk menggunakan.', 'success');
        }
      }
    };
  }
  
  content.innerHTML = `
    ${arrow}
    <span class="tree-icon">${icon}</span>
    <span class="tree-name">${item.name}</span>
  `;
  
  node.appendChild(content);
  
  // Create children container for folders
  if (item.type === 'dir') {
    const childrenContainer = document.createElement('div');
    childrenContainer.className = 'tree-children';
    node.appendChild(childrenContainer);
    
    // Add existing children
    if (item.children && item.children.length > 0) {
      item.children.forEach(child => {
        childrenContainer.appendChild(createTreeNode(child, depth + 1));
      });
    }
  }
  
  return node;
}

// Load directory content from GitHub API
async function loadDirectoryContent(item, parentNode) {
  if (!item.url) return;
  
  const pat = document.getElementById('pat').value.trim();
  if (!pat) return;
  
  try {
    showBrowseStatus('Memuat direktori...', 'loading');
    
    const response = await fetch(item.url, {
      headers: {
        'Authorization': `Bearer ${pat}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`Gagal memuat direktori: ${response.status}`);
    }
    
    const contents = await response.json();
    
    // Filter and map contents
    const children = contents
      .filter(content => content.type === 'dir' || content.type === 'file')
      .map(content => ({
        name: content.name,
        type: content.type,
        url: content.url,
        path: `${item.path || item.name}/${content.name}`,
        size: content.size,
        children: content.type === 'dir' ? [] : undefined
      }));
    
    // Update item children
    item.children = children;
    
    // Update tree
    const childrenContainer = parentNode.querySelector('.tree-children');
    childrenContainer.innerHTML = '';
    
    children.forEach(child => {
      childrenContainer.appendChild(createTreeNode(child));
    });
    
    // Update stats
    updateBrowseStats(
      repositories.length,
      document.querySelectorAll('.tree-node[data-type="dir"]').length,
      document.querySelectorAll('.tree-node[data-type="file"]').length
    );
    
    showBrowseStatus('Direktori berhasil dimuat', 'success');
    
  } catch (error) {
    console.error('Error loading directory:', error);
    showBrowseStatus(`Error memuat direktori: ${error.message}`, 'error');
  }
}

// Load repositories from GitHub API
async function loadRepositories() {
  const pat = document.getElementById('pat').value.trim();
  
  if (!pat) {
    showBrowseStatus('Silakan masukkan GitHub Personal Access Token', 'error');
    return;
  }
  
  if (!pat.startsWith('ghp_') && !pat.startsWith('github_pat_')) {
    showBrowseStatus('Format token tidak valid. Token GitHub harus dimulai dengan "ghp_" atau "github_pat_"', 'error');
    return;
  }
  
  // Show loading state
  loadReposBtn.disabled = true;
  loadReposBtn.classList.add('loading');
  showBrowseStatus('Memuat repositori dari GitHub...', 'loading');
  repoBrowser.style.display = 'none';
  
  try {
    // Load repositories with pagination
    let allRepos = [];
    let page = 1;
    let hasMore = true;
    
    while (hasMore) {
      const response = await fetch(`https://api.github.com/user/repos?per_page=100&page=${page}&sort=updated`, {
        headers: {
          'Authorization': `Bearer ${pat}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });
      
      if (!response.ok) {
        if (response.status === 401) {
          throw new Error('Token tidak valid atau sudah kadaluarsa');
        }
        throw new Error(`Error GitHub API: ${response.status}`);
      }
      
      const repos = await response.json();
      allRepos = [...allRepos, ...repos];
      
      // Check for more pages
      const linkHeader = response.headers.get('Link');
      hasMore = linkHeader && linkHeader.includes('rel="next"');
      page++;
      
      // Update status
      showBrowseStatus(`Memuat repositori... (${allRepos.length} ditemukan)`, 'loading');
    }
    
    if (allRepos.length === 0) {
      showBrowseStatus('Tidak ada repositori ditemukan', 'error');
      return;
    }
    
    // Process repositories
    repositories = allRepos.map(repo => ({
      name: repo.name + (repo.private ? ' üîí' : ''),
      full_name: repo.full_name,
      private: repo.private,
      url: repo.contents_url.replace('{+path}', '') + `?ref=${repo.default_branch}`,
      path: repo.name,
      type: 'dir',
      children: []
    }));
    
    // Render tree
    repoTree.innerHTML = '';
    
    if (repositories.length > 0) {
      repositories.forEach(repo => {
        const treeNode = createTreeNode(repo);
        repoTree.appendChild(treeNode);
      });
    } else {
      repoTree.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üì≠</div>
          <div>Tidak ada repositori</div>
        </div>
      `;
    }
    
    // Show repository browser
    repoBrowser.style.display = 'block';
    
    // Update stats
    updateBrowseStats(repositories.length, 0, 0);
    
    showBrowseStatus(`Berhasil memuat ${repositories.length} repositori`, 'success');
    
  } catch (error) {
    console.error('Error loading repositories:', error);
    showBrowseStatus(`Error: ${error.message}`, 'error');
  } finally {
    loadReposBtn.disabled = false;
    loadReposBtn.classList.remove('loading');
  }
}

// ======================== EVENT LISTENERS ========================

// Mode tabs switching
modeTabs.forEach(tab => {
  tab.addEventListener('click', () => {
    setBrowseMode(tab.dataset.mode);
  });
});

// Load repositories button
loadReposBtn.addEventListener('click', loadRepositories);

// ======================== UTILITY FUNCTIONS ========================

function toggleDarkMode() {
  const isDark = document.body.style.backgroundColor === 'rgb(15, 23, 42)';
  
  if (isDark) {
    // Switch to light mode
    document.documentElement.style.setProperty('--bg', '#f2f2f2');
    document.documentElement.style.setProperty('--panel', '#fff');
    document.documentElement.style.setProperty('--item', '#f5f5f5');
    document.documentElement.style.setProperty('--text', '#111');
    document.documentElement.style.setProperty('--muted', '#666');
    document.documentElement.style.setProperty('--accent', '#111');
    document.documentElement.style.setProperty('--line', '#ccc');
    document.documentElement.style.setProperty('--input-bg', '#fff');
    document.documentElement.style.setProperty('--sidebar-bg', '#fff');
  } else {
    // Switch to dark mode
    document.documentElement.style.setProperty('--bg', '#0f172a');
    document.documentElement.style.setProperty('--panel', '#111827');
    document.documentElement.style.setProperty('--item', '#1f2937');
    document.documentElement.style.setProperty('--text', '#e5e7eb');
    document.documentElement.style.setProperty('--muted', '#9ca3af');
    document.documentElement.style.setProperty('--accent', '#22c55e');
    document.documentElement.style.setProperty('--line', '#4b5563');
    document.documentElement.style.setProperty('--input-bg', '#1e293b');
    document.documentElement.style.setProperty('--sidebar-bg', '#0f172a');
  }
}

// ======================== INITIALIZATION ========================

window.addEventListener('DOMContentLoaded', () => {
  // Initialize main app
  const offlineTab = document.querySelector('.tab[data-tab="Offline"]');
  switchTab(offlineTab);
  
  // Close modal on click outside
  imageModal.addEventListener('click', (e) => {
    if (e.target === imageModal) {
      closeImageModal();
    }
  });
  
  // Keyboard navigation for image modal
  document.addEventListener('keydown', (e) => {
    if (imageModal.classList.contains('active')) {
      if (e.key === 'ArrowLeft') {
        prevImage();
      } else if (e.key === 'ArrowRight') {
        nextImage();
      } else if (e.key === 'Escape') {
        closeImageModal();
      }
    }
  });
  
  // Initialize browse mode
  const savedBrowseMode = localStorage.getItem('setting_browseMode') || 'type';
  setBrowseMode(savedBrowseMode);
  
  // Initialize selected path from settings
  updateSelectedPathFromSettings();
  
  // Auto-load repositories if PAT exists and in browse mode
  if (savedBrowseMode === 'browse') {
    const pat = document.getElementById('pat').value.trim();
    if (pat) {
      setTimeout(() => loadRepositories(), 500);
    }
  }
  
  // Close sidebar when clicking overlay
  overlay.addEventListener('click', () => {
    if (sidebar.classList.contains('active')) {
      toggleSidebar();
    }
  });
});
</script>
</body>
</html>